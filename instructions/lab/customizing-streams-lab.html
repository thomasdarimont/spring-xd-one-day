<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;3.&nbsp;Customizing Streams</title><link rel="stylesheet" href="css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.70.0"><link rel="start" href="index.html" title="Spring XD - Lab Documentation"><link rel="up" href="index.html" title="Spring XD - Lab Documentation"><link rel="prev" href="introduction-to-streams-lab.html" title="Chapter&nbsp;2.&nbsp;Introduction to Streams"><link rel="next" href="advanced-streams-lab.html" title="Chapter&nbsp;4.&nbsp;Advanced Streams"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns="http://www.w3.org/TR/xhtml1/transitional" style="background-color:white;border:none;height:73px;border:1px solid black;"><a style="border:none;" href="http://www.pivotal.io" title="Pivotal"><img style="border:none;" src="images/heading-logo-lhs.jpg"></img></a><a style="border:none;" href="http://www.spring.io" title="The Spring Framework"><img style="border:none;position:absolute;padding-top:5px;right:42px;" src="images/heading-logo-rhs.jpg"></img></a></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="customizing-streams-lab"></a>Chapter&nbsp;3.&nbsp;Customizing Streams</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="customizing-streams-lab-objective"></a>3.1.&nbsp;Objective</h2></div></div></div><p>To install a custom module in Spring XD,
			  create a composite module in the Spring XD shell, and deploy a stream that uses it.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="customizing-streams-lab-installing"></a>3.2.&nbsp;Installing a Custom Module</h2></div></div></div><p>In this exercise, we will build and install a custom processor as a custom module into Spring XD.</p><div class="orderedlist"><ol type="1" compact><li><p>Before installing the custom module, let's modify the location of the custom module registry. 
					  Create a subdirectory in your user home directory called <code class="code">xd-custom-modules</code>.
					  Open the Spring XD <code class="code">servers.yml</code> file (located within XD-HOME/config), 
					  uncomment the <code class="code">xd.customModule.home</code> section and set the  property
					  to the location of the new directory. For Example:
				</p><p>
</p><pre class="programlisting">xd:
  customModule:
    home: file:///Users/glennrenfro/empty/xd-custom-modules
    -or-
    home: file://c:/project/customModules</pre><p>
				</p><p>Restart the Spring-XD server to pick up the changes.</p></li><li><p>Now, we will build the custom processor.  Change to the <code class="code">payload-conversion</code> lab project directory,
					  and execute</p><pre class="programlisting">mvn clean package</pre><p>Verify the project built successfully by checking the <code class="code">jar</code> file was created in the 
					  <code class="code">target</code> subdirectory.</p></li><li><p>Launch the XD shell, and use the <code class="code">module upload</code> command to upload the module JAR file into the custom repository.</p><pre class="programlisting">xd:&gt;module upload --name payload-conversion --type processor $LAB_HOME/
labs/payload-conversion/target/payload-conversion-1.0.0.BUILD-SNAPSHOT.jar
Successfully uploaded module 'processor:payload-conversion'
-or-
xd:&gt;module upload --name payload-conversion --type processor c:/$LAB_HOME/
labs/payload-conversion/target/payload-conversion-1.0.0.BUILD-SNAPSHOT.jar</pre></li><li><p>Verify the module was successfully uploaded by finding it in the output of the <code class="code">module list</code>.</p></li><li><p>Take a look at the contents of the custom modules directory, and see that the jar file
					  has been copied there.</p></li><li><p>Now use the XD shell to create a stream using the custom module:</p><pre class="programlisting">xd:&gt;stream create --name test --definition "http | payload-conversion --inputType=application/x-xd-tuple | file" --deploy
Created and deployed new stream 'test'
xd:&gt;</pre></li><li><p>Test the stream by posting some JSON content to the HTTP source:</p><pre class="programlisting">xd:&gt;http post --data {"symbol":"FAKE","price":75} --contentType "application/json"</pre><p>Check the output of the stream, but dumping the contents of the output file.  On Mac OSX and Linux, enter:</p><pre class="programlisting">xd:&gt;! cat /tmp/xd/output/test.out</pre><p>On Mac Windows, enter:</p><pre class="programlisting">xd:&gt;! cat /temp/xd/output/test.out</pre><p>You should observe the following output of the file:</p><pre class="programlisting">{"id":"719f5276-22d2-434d-87dc-39a23a978077","timestamp":1376387174881,"symbol":"FAKE","price":"75"}</pre><p>Note the tuple conversion has added <code class="code">id</code> and <code class="code">timestamp</code> fields.  What has occurred is that
					  the JSON has been converted to a Java <code class="code">org.springframework.xd.tuple.DefaultTuple</code> object, then
					  output as a String using the <code class="code">toString()</code> method.  When a new <code class="code">DefaultTuple</code> object
					  is instantiated, a unique ID (GUID) and timestamp is added to the object.  On converting the object back
					  to a <code class="code">String</code>, those fields are included as part of the output.</p></li><li><p>Destroy the stream, then delete the custom module using the <code class="code">module delete --name processor:tupleProcessor</code> command.  
					  Note how when executing this command the xd-shell expects you to prefix the module name with it's type.</p><p>Open the <code class="code">$LAB_HOME/payload-conversion/src/main/java/org/springframework/xd/samples/conversion/MyTupleProcessor.java</code>, and
					  examine the contents.  Observe how the processor expects a tuple as input, and simply returns that
					  tuple from the <code class="code">process()</code> method.  The file sink simply invokes the <code class="code">toString()</code>
					  method on the tuple returned from this method.</p></li></ol></div></div></div><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navfooter"><hr></hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="introduction-to-streams-lab.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="advanced-streams-lab.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;2.&nbsp;Introduction to Streams&nbsp;</td><td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.spring.io" title="The Spring Framework">Spring By Pivotal</a></span></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;4.&nbsp;Advanced Streams</td></tr></table></div></body></html>